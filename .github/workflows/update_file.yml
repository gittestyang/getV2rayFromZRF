# This is a basic workflow that is manually triggered

name: yoyapaiv2ray

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  schedule:

    - cron: '0 * * * *'


  workflow_dispatch: # 允许手动触发执行

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "greet"
  update_subscription:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须授予写入权限才能提交和推送
      pull-requests: write # 可选，如果工作流需要操作 PR

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Runs a single command using the runners shell
      #- name: Send greeting
      #  run: echo "Hello ${{ inputs.remote_url }}"
      - name: Checkout Repository
        uses: actions/checkout@v4


      - name: Download file with dynamic date
        run: |
          # 获取北京时间 (UTC+8) 的日期，格式为 YYYYMMDD
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')

          # 构造完整的 URL
          URL="https://yoyapai.com/mianfeijiedian/${CURRENT_DATE}-ssr-v2ray-vpn-jiedian-yoyapai.com.txt"

          echo "Attempting to download from: $URL"

          # 使用 curl 下载文件到 data 目录
          # -f 参数在 404 时返回非零退出码
          # -L 参数跟随重定向
          # -o 指定输出路径
          curl -f -L -o data/nodes.txt "$URL" || echo "Warning: File not found for today yet."

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 检查是否有内容变化
          if [ -n "$(git status --porcelain)" ]; then
            git add data/nodes.txt
            git commit -m "Update nodes for $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "No changes detected, skipping commit."
          fi

