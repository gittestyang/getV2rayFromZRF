# This is a basic workflow that is manually triggered

name: zrfv2ray

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  schedule:
    # ç¬¬ä¸€æ¬¡è¿è¡Œï¼šæ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿ (ä¾‹å¦‚ 01:00, 02:00, 03:00)
    - cron: '0 * * * *'
    
    # ç¬¬äºŒæ¬¡è¿è¡Œï¼šæ¯å°æ—¶çš„ç¬¬ 20 åˆ†é’Ÿ (ä¾‹å¦‚ 01:20, 02:20, 03:20)
    - cron: '20 * * * *'
    
    # ç¬¬ä¸‰æ¬¡è¿è¡Œï¼šæ¯å°æ—¶çš„ç¬¬ 40 åˆ†é’Ÿ (ä¾‹å¦‚ 01:40, 02:40, 03:40)
    - cron: '40 * * * *'
  workflow_dispatch:
    # Inputs the workflow accepts.
    inputs:
      remote_url:
        description: 'HTTP URL'
        default: 'https://raw.githubusercontent.com/shaoyouvip/free/refs/heads/main/base64.txt' # ï¿½ï¿½ï¿½æ»»Îªï¿½ï¿½ï¿½ï¿½Ä¬ï¿½ï¿½URL
      target_file:
        description: 'data/my_content.txt)'
        default: 'data/zrf_content.txt' # ï¿½ï¿½ï¿½æ»»Îªï¿½ï¿½ï¿½ï¿½Ä¿ï¿½ï¿½ï¿½Ä¼ï¿½

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "greet"
  subcribe:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Runs a single command using the runners shell
    - name: Send greeting
      run: echo "Hello ${{ inputs.remote_url }}"
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Set Variables
      id: vars
      run: |
        # ç¡®ä¿è¾“å…¥æˆ–é»˜è®¤å€¼è¢«ä¼ é€’ç»™åç»­æ­¥éª¤
        REMOTE_URL="${{ github.event.inputs.remote_url || 'https://example.com/data/remote_content.txt' }}"
        TARGET_FILE="${{ github.event.inputs.target_file || 'data/updated_content.txt' }}"
        echo "remote_url=$REMOTE_URL" >> $GITHUB_OUTPUT
        echo "target_file=$TARGET_FILE" >> $GITHUB_OUTPUT

    # 3. é€šè¿‡ HTTP è·å–è¿œç«¯æ–‡ä»¶å¹¶å¤„ç†
    - name: âš™ï¸ Fetch and Process Remote File
      id: process
      # ä½¿ç”¨ Shell è„šæœ¬å®Œæˆä¸‹è½½ã€å¤„ç†å’Œä¿å­˜
      run: |
        REMOTE_URL="${{ steps.vars.outputs.remote_url }}"
        TARGET_FILE="${{ steps.vars.outputs.target_file }}"
        
        echo "Downloading file from: $REMOTE_URL"
        
        # a. ä¸‹è½½è¿œç«¯æ–‡ä»¶å†…å®¹
        # ä½¿ç”¨ wget æˆ– curlï¼Œè¿™é‡Œä½¿ç”¨ curl 
        curl -s "$REMOTE_URL" -o remote_content.tmp
        
        # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
        if [ ! -f remote_content.tmp ]; then
          echo "::error::æ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©ºã€‚"
          exit 1
        fi
        
        echo "Processing file content..."
        
        # b. ä½¿ç”¨ sed ç§»é™¤æœ«å°¾çš„æ—¶é—´æˆ³ï¼š
        # æ­£åˆ™è¡¨è¾¾å¼ (#[ç©ºæ ¼]YYYY-MM-DD[ç©ºæ ¼]HH:MM:SS) ç§»é™¤æ‰æ–‡ä»¶çš„æœ€åä¸€è¡Œ
        # æ³¨æ„: å¦‚æœæ—¶é—´æˆ³ä¸ä¸€å®šæ˜¯æ–‡ä»¶çš„æœ€åä¸€è¡Œï¼Œè¯·è°ƒæ•´ sed å‘½ä»¤
        # $!b è¡¨ç¤ºå¦‚æœä¸æ˜¯æœ€åä¸€è¡Œï¼Œåˆ™è·³åˆ°è¡Œå°¾ï¼›N è¡¨ç¤ºè¯»å–ä¸‹ä¸€è¡Œï¼›/.../ è¡¨ç¤ºåŒ¹é…å¹¶æ›¿æ¢
        
        # ç§»é™¤æ–‡ä»¶æœ€åä¸€è¡Œä¸­åŒ¹é… "# YYYY-MM-DD HH:MM:SS" çš„å†…å®¹
        # æ³¨æ„: è¿™æ¡å‘½ä»¤å‡è®¾æ—¶é—´æˆ³åœ¨æ–‡ä»¶çš„æœ«å°¾ï¼Œå¹¶ä¸”å‰é¢æ²¡æœ‰å…¶ä»–å†…å®¹
        PROCESSED_CONTENT=$(sed 's/# [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}$//' remote_content.tmp)
        
        # æ‰“å°å¤„ç†åçš„å†…å®¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        echo "--- Processed Content Start ---"
        echo "$PROCESSED_CONTENT"
        echo "--- Processed Content End ---"
        
        # c. å°†å¤„ç†åçš„å†…å®¹å†™å…¥ç›®æ ‡æ–‡ä»¶
        # æ³¨æ„: ç¡®ä¿ç›®æ ‡æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•å­˜åœ¨
        
        mkdir -p "$(dirname "$TARGET_FILE")"
        echo "$PROCESSED_CONTENT" > "$TARGET_FILE"
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --exit-code "$TARGET_FILE"; then
          echo "::notice::ç›®æ ‡æ–‡ä»¶å†…å®¹æœªå‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          # echo "commit_needed=false" >> $GITHUB_OUTPUT
          echo "commit_needed=true" >> $GITHUB_OUTPUT
        else
          echo "::notice::ç›®æ ‡æ–‡ä»¶å†…å®¹å·²æ›´æ–°ï¼Œå‡†å¤‡æäº¤ã€‚"
          echo "commit_needed=true" >> $GITHUB_OUTPUT
        fi
      
    # 4. æäº¤å˜åŒ– (ä»…åœ¨æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰§è¡Œ)
    - name: ğŸ’¾ Commit changes
      if: steps.process.outputs.commit_needed == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        # æäº¤çš„æäº¤ä¿¡æ¯
        commit_message: 'CI(update): Auto-update content from remote source'
        # è¦æäº¤çš„æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨æ­¥éª¤3ä¸­å®šä¹‰çš„ TARGET_FILE
        file_pattern: ${{ steps.vars.outputs.target_file }}
        # GitHub Action çš„å†…ç½® Tokenï¼Œç”¨äºæäº¤åˆ°ä»“åº“
        token: ${{ secrets.GITHUB_TOKEN }}
        # Git ä½œè€…ä¿¡æ¯
        commit_user_name: GitHub Actions Bot
        commit_user_email: actions@github.com 
